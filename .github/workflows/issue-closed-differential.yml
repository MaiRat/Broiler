name: Issue Closed â€“ Acid1 Differential Report

on:
  issues:
    types: [closed]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to reference in the report'
        required: false
        default: '0'
      issue_title:
        description: 'Issue title to reference in the report'
        required: false
        default: 'Manual run'

permissions:
  contents: write

jobs:
  acid1-differential-report:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore Broiler.slnx

    - name: Build
      run: dotnet build Broiler.slnx --no-restore --configuration Release

    - name: Install Playwright Chromium
      run: pwsh HTML-Renderer-1.5.2/Source/HtmlRenderer.Image.Tests/bin/Release/net8.0/playwright.ps1 install --with-deps chromium

    - name: Determine next document number
      id: docnum
      run: |
        # Find the highest-numbered ADR document and increment
        highest=$(ls docs/adr/*.md 2>/dev/null \
          | sed -n 's|.*/\([0-9]\{3\}\)-.*\.md$|\1|p' \
          | sort -rn | head -1)
        if [ -z "$highest" ]; then
          highest=9
        fi
        next=$(printf "%03d" $((10#$highest + 1)))
        echo "doc_number=$next" >> "$GITHUB_OUTPUT"
        echo "Next document number: $next"

    - name: Resolve issue metadata
      id: meta
      run: |
        if [ "${{ github.event_name }}" = "issues" ]; then
          echo "issue_number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          # Sanitise title for safe shell usage
          title=$(echo "${{ github.event.issue.title }}" | tr -cd '[:alnum:] [:space:]._-')
          echo "issue_title=$title" >> "$GITHUB_OUTPUT"
        else
          echo "issue_number=${{ github.event.inputs.issue_number || '0' }}" >> "$GITHUB_OUTPUT"
          echo "issue_title=${{ github.event.inputs.issue_title || 'Manual run' }}" >> "$GITHUB_OUTPUT"
        fi

    - name: Generate Acid1 Differential Report
      env:
        ACID1_REPORT_OUTPUT: ${{ github.workspace }}/docs/adr/${{ steps.docnum.outputs.doc_number }}-acid1-differential-testing-errors.md
        ACID1_REPORT_ISSUE_NUMBER: ${{ steps.meta.outputs.issue_number }}
        ACID1_REPORT_ISSUE_TITLE: ${{ steps.meta.outputs.issue_title }}
        ACID1_REPORT_DOC_NUMBER: ${{ steps.docnum.outputs.doc_number }}
        ACID1_REPORT_RUN_ID: ${{ github.run_id }}
        ACID1_REPORT_COMMIT_SHA: ${{ github.sha }}
        ACID1_REPORT_REPO: ${{ github.repository }}
      run: >
        dotnet test
        HTML-Renderer-1.5.2/Source/HtmlRenderer.Image.Tests/HtmlRenderer.Image.Tests.csproj
        --no-build --configuration Release --verbosity normal
        --filter "Category=DifferentialReport"

    - name: Commit and push report
      run: |
        doc_number="${{ steps.docnum.outputs.doc_number }}"
        report_file="docs/adr/${doc_number}-acid1-differential-testing-errors.md"

        if [ ! -f "$report_file" ]; then
          echo "::warning::Report file not generated: $report_file"
          exit 0
        fi

        git config user.name  "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add "$report_file"
        git commit -m "docs: add ADR-${doc_number} acid1 differential report (issue #${{ steps.meta.outputs.issue_number }})"
        git push

    - name: Upload Differential Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: acid1-differential-reports
        path: |
          docs/adr/*-acid1-differential-testing-errors.md
          HTML-Renderer-1.5.2/Source/HtmlRenderer.Image.Tests/TestData/Acid1DifferentialReports/
        if-no-files-found: ignore
