name: Nightly Differential Tests

on:
  schedule:
    # Run every night at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read

jobs:
  differential:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore Broiler.slnx

    - name: Build
      run: dotnet build Broiler.slnx --no-restore --configuration Release

    - name: Install Playwright Chromium
      run: pwsh HTML-Renderer-1.5.2/Source/HtmlRenderer.Image.Tests/bin/Release/net8.0/playwright.ps1 install --with-deps chromium

    - name: Run Differential Tests
      run: dotnet test HTML-Renderer-1.5.2/Source/HtmlRenderer.Image.Tests/HtmlRenderer.Image.Tests.csproj --no-build --configuration Release --verbosity normal --filter "Category=Differential"

    - name: Upload Differential Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: differential-reports
        path: |
          HTML-Renderer-1.5.2/Source/HtmlRenderer.Image.Tests/TestData/DifferentialReports/
          HTML-Renderer-1.5.2/Source/HtmlRenderer.Image.Tests/TestData/Acid1DifferentialReports/
        if-no-files-found: ignore
